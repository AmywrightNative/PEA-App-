<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecological Appraisal App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #report-output, #report-output * {
                visibility: visible;
            }
            #report-output {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loader" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
        </div>

        <div id="message-box" class="hidden fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50"></div>

        <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Preliminary Ecological Appraisal Report</h1>
            <p class="text-gray-600 mb-6">Onsite data collection and reporting tool.</p>
            
            <div class="bg-gray-100 p-4 rounded-lg mb-6 border">
                <h3 class="font-bold text-lg mb-2">Manage Project Data</h3>
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex-grow">
                        <label for="loadProjectNumber" class="sr-only">Project Number to Load</label>
                        <input type="text" id="loadProjectNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter Project No. to Load">
                    </div>
                    <button id="load-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Load Project</button>
                    <button id="save-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Save Current Project</button>
                </div>
            </div>

            <div id="stepper" class="flex items-center justify-between mb-8 text-sm md:text-base">
                <div class="step flex-1 flex items-center justify-center border-b-4 pb-2 step-active" data-step="1">
                    <span class="rounded-full bg-blue-500 text-white w-8 h-8 flex items-center justify-center mr-2">1</span>
                    <span class="font-medium">Project</span>
                </div>
                <div class="step flex-1 flex items-center justify-center border-b-2 pb-2 text-gray-400" data-step="2">
                    <span class="rounded-full bg-gray-300 text-gray-600 w-8 h-8 flex items-center justify-center mr-2">2</span>
                    <span class="font-medium">Habitats</span>
                </div>
                <div class="step flex-1 flex items-center justify-center border-b-2 pb-2 text-gray-400" data-step="3">
                    <span class="rounded-full bg-gray-300 text-gray-600 w-8 h-8 flex items-center justify-center mr-2">3</span>
                    <span class="font-medium">Buildings</span>
                </div>
                <div class="step flex-1 flex items-center justify-center border-b-2 pb-2 text-gray-400" data-step="4">
                    <span class="rounded-full bg-gray-300 text-gray-600 w-8 h-8 flex items-center justify-center mr-2">4</span>
                    <span class="font-medium">Trees</span>
                </div>
                 <div class="step flex-1 flex items-center justify-center border-b-2 pb-2 text-gray-400" data-step="5">
                    <span class="rounded-full bg-gray-300 text-gray-600 w-8 h-8 flex items-center justify-center mr-2">5</span>
                    <span class="font-medium">Prot. Species</span>
                </div>
                 <div class="step flex-1 flex items-center justify-center border-b-2 pb-2 text-gray-400" data-step="6">
                    <span class="rounded-full bg-gray-300 text-gray-600 w-8 h-8 flex items-center justify-center mr-2">6</span>
                    <span class="font-medium">Summary</span>
                </div>
            </div>

            <form id="pea-form">
                <div id="step-1" class="step-content">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">1. Project Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label><input type="text" id="projectName" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="projectNumber" class="block text-sm font-medium text-gray-700 mb-1">Project Number</label><input type="text" id="projectNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div class="md:col-span-2"><label for="siteAddress" class="block text-sm font-medium text-gray-700 mb-1">Site Address</label><input type="text" id="siteAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Surveyor(s)</label>
                            <div id="surveyors-container" class="space-y-2"></div>
                            <button type="button" id="add-surveyor-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Add Surveyor</button>
                        </div>
                        <div><label for="gridReference" class="block text-sm font-medium text-gray-700 mb-1">Grid Reference</label><input type="text" id="gridReference" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label><input type="date" id="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label><input type="time" id="startTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">End Time</label><input type="time" id="endTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="temperature" class="block text-sm font-medium text-gray-700 mb-1">Temperature (°C)</label><input type="number" id="temperature" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div>
                            <label for="cloudCover" class="block text-sm font-medium text-gray-700 mb-1">Cloud Cover</label>
                            <select id="cloudCover" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="">Select cloud cover...</option>
                                <script>
                                    for(let i = 0; i <= 100; i+=5) {
                                        document.write(`<option value="${i}%">${i}%</option>`);
                                    }
                                </script>
                            </select>
                        </div>
                        <div>
                            <label for="wind" class="block text-sm font-medium text-gray-700 mb-1">Wind</label>
                            <select id="wind" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="">Select Beaufort scale...</option>
                                <option value="0 - Calm">0 - Calm (&lt;1 mph): Smoke rises vertically.</option>
                                <option value="1 - Light Air">1 - Light Air (1-3 mph): Wind motion visible in smoke.</option>
                                <option value="2 - Light Breeze">2 - Light Breeze (4-7 mph): Wind felt on face; leaves rustle.</option>
                                <option value="3 - Gentle Breeze">3 - Gentle Breeze (8-12 mph): Leaves and small twigs in constant motion.</option>
                                <option value="4 - Moderate Breeze">4 - Moderate Breeze (13-18 mph): Raises dust and loose paper.</option>
                                <option value="5 - Fresh Breeze">5 - Fresh Breeze (19-24 mph): Small trees in leaf begin to sway.</option>
                                <option value="6 - Strong Breeze">6 - Strong Breeze (25-31 mph): Large branches in motion.</option>
                                <option value="7 - Near Gale">7 - Near Gale (32-38 mph): Whole trees in motion.</option>
                                <option value="8 - Gale">8 - Gale (39-46 mph): Twigs break off trees.</option>
                                <option value="9 - Strong Gale">9 - Strong Gale (47-54 mph): Slight structural damage occurs.</option>
                                <option value="10 - Storm">10 - Storm (55-63 mph): Trees uprooted.</option>
                                <option value="11 - Violent Storm">11 - Violent Storm (64-72 mph): Widespread damage.</option>
                                <option value="12 - Hurricane">12 - Hurricane (≥73 mph): Devastation.</option>
                            </select>
                        </div>
                        <div>
                            <label for="rain" class="block text-sm font-medium text-gray-700 mb-1">Rain</label>
                            <select id="rain" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="">Select rain condition...</option>
                                <option value="None">None</option>
                                <option value="Drizzle">Drizzle</option>
                                <option value="Light">Light</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Heavy">Heavy</option>
                            </select>
                        </div>
                        <div>
                            <label for="groundConditions" class="block text-sm font-medium text-gray-700 mb-1">Ground Conditions</label>
                            <select id="groundConditions" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="">Select ground conditions...</option>
                                <option value="Deep cracks">Deep cracks</option>
                                <option value="Dry">Dry</option>
                                <option value="Damp">Damp</option>
                                <option value="Wet">Wet</option>
                                <option value="Waterlogged">Waterlogged</option>
                            </select>
                        </div>
                        <div class="md:col-span-2"><label for="surveyLimitations" class="block text-sm font-medium text-gray-700 mb-1">Survey Limitations</label><textarea id="surveyLimitations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                    </div>
                </div>

                <div id="step-2" class="step-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">2. Habitats and Parcels</h2>
                    <div id="habitats-container" class="space-y-6"></div>
                    <button type="button" id="add-habitat-btn" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Add Habitat</button>
                </div>

                <div id="step-3" class="step-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">3. Buildings</h2>
                    <div id="buildings-container" class="space-y-6"></div>
                    <button type="button" id="add-building-btn" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Add Building</button>
                </div>
                
                <div id="step-4" class="step-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">4. Trees</h2>
                    <div id="trees-container" class="space-y-6"></div>
                    <button type="button" id="add-tree-btn" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Add Tree</button>
                </div>

                <div id="step-5" class="step-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">5. Protected Species Potential</h2>
                    <div id="species-accordion" class="space-y-2">
                        <!-- Foraging & Commuting Bats -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Foraging & Commuting Bats</button>
                           <div class="accordion-content px-4 pb-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium">Description of habitat</label>
                                        <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="bats_habitat_desc" rows="3"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Further survey required?</label>
                                        <select class="w-full mt-1 p-2 border rounded-lg bg-white" data-species-field="bats_survey_req">
                                            <option value="">Select...</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Suitability for survey</label>
                                        <select class="w-full mt-1 p-2 border rounded-lg bg-white" data-species-field="bats_survey_suitability">
                                            <option value="">Select...</option>
                                            <option value="Low">Low</option>
                                            <option value="Moderate">Moderate</option>
                                            <option value="High">High</option>
                                        </select>
                                    </div>
                                    <div><label class="block text-sm font-medium">How many transects</label><input type="number" class="w-full mt-1 p-2 border rounded-lg" data-species-field="bats_transects"></div>
                                    <div><label class="block text-sm font-medium">How many VPs</label><input type="number" class="w-full mt-1 p-2 border rounded-lg" data-species-field="bats_vps"></div>
                                </div>
                           </div>
                        </div>
                        <!-- Hazel Dormice -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Hazel Dormice</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">Habitat Suitability</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="dormice_habitat"></textarea>
                                <label class="block text-sm font-medium mt-2">Evidence Found (e.g., nuts, nests)</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="dormice_evidence"></textarea>
                           </div>
                        </div>
                        <!-- Badger -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Badger</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">Field Signs (latrines, tracks, hairs etc.)</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="badger_signs"></textarea>
                                <div class="mt-2"><label class="inline-flex items-center"><input type="checkbox" class="rounded" data-species-field="badger_sett_onsite"> <span class="ml-2">Sett on site?</span></label></div>
                                <div class="mt-2"><label class="inline-flex items-center"><input type="checkbox" class="rounded" data-species-field="badger_buffer_checked"> <span class="ml-2">30m buffer checked?</span></label></div>
                           </div>
                        </div>
                        <!-- Reptiles -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Reptiles</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">Habitat Suitability (foraging, basking, refugia)</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="reptiles_habitat"></textarea>
                           </div>
                        </div>
                        <!-- Great Crested Newts -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Great Crested Newts</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">HSI Score (if applicable)</label>
                                <input type="text" class="w-full mt-1 p-2 border rounded-lg" data-species-field="gcn_hsi">
                                <label class="block text-sm font-medium mt-2">Terrestrial Habitat Quality</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="gcn_habitat"></textarea>
                                <label class="block text-sm font-medium mt-2">Ponds on/within 500m?</label>
                                <select class="w-full mt-1 p-2 border rounded-lg bg-white" data-species-field="gcn_ponds">
                                    <option value="">Select...</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                           </div>
                        </div>
                        <!-- Birds -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Birds</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">Nesting Opportunities</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="birds_nesting"></textarea>
                                <label class="block text-sm font-medium mt-2">Notable Species Observed</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="birds_observed"></textarea>
                           </div>
                        </div>
                         <!-- Riparian Mammals -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Riparian Mammals</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">Waterbody Suitability</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="riparian_suitability"></textarea>
                                <label class="block text-sm font-medium mt-2">Field Signs (spraints, latrines, burrows etc.)</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="riparian_signs"></textarea>
                           </div>
                        </div>
                         <!-- Other -->
                        <div class="accordion-item bg-gray-50 rounded-lg border">
                           <button type="button" class="accordion-header w-full text-left p-4 font-semibold">Other Protected Species</button>
                           <div class="accordion-content px-4 pb-4">
                                <label class="block text-sm font-medium">Notes on other species</label>
                                <textarea class="w-full mt-1 p-2 border rounded-lg" data-species-field="other_species_notes"></textarea>
                           </div>
                        </div>
                    </div>
                </div>

                <div id="step-6" class="step-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">6. Summary and Report</h2>
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h3 class="font-bold text-xl mb-4">Appraisal Summary</h3>
                        <div id="summary-content" class="space-y-4"></div>
                         <div class="mt-6">
                            <button type="button" id="generate-mitigation-btn" class="w-full text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:bg-gradient-to-l focus:ring-4 focus:outline-none focus:ring-purple-200 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                                ✨ Generate Mitigation Suggestions with AI
                            </button>
                        </div>
                    </div>
                    <div id="mitigation-output" class="hidden mt-6 bg-gray-50 p-6 rounded-lg border">
                        <h3 class="font-bold text-xl mb-4">AI-Generated Mitigation Suggestions</h3>
                        <div id="mitigation-content" class="prose max-w-none prose-sm"></div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Site Plan/Map</h3>
                        <p class="text-gray-600 mb-4">Upload a site plan or map showing target note locations.</p>
                        <input type="file" accept="image/*" id="site-plan-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
            </form>

            <div class="mt-8 pt-5 border-t border-gray-200 flex justify-between">
                <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg hidden">Previous</button>
                <button id="next-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Next</button>
                <button id="generate-report-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg hidden">Generate Report</button>
            </div>
        </div>
    </div>
    
    <datalist id="plant-datalist"></datalist>

    <div id="report-output" class="hidden mt-8 bg-white p-8 rounded-lg shadow-lg">
        <div id="report-content" class="prose max-w-none"></div>
        <div class="mt-8 text-center no-print">
            <button id="back-to-form-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg mr-4">Back to Form</button>
            <button id="print-report-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Print Report</button>
        </div>
    </div>

    <!-- Main App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            const firebaseConfig = {
              apiKey: "AIzaSyDRa-XGqAbwoD0nntMSgdqEKdzse7n6sO8",
              authDomain: "pea-pro-former-app.firebaseapp.com",
              projectId: "pea-pro-former-app",
              storageBucket: "pea-pro-former-app.appspot.com",
              messagingSenderId: "101171413137",
              appId: "1:101171413137:web:cdd9b1c4cbb8c4a697bf30"
            };
            
            let db;
            let currentStep = 1;
            
            const loader = document.getElementById('loader');
            const messageBox = document.getElementById('message-box');
            const peaForm = document.getElementById('pea-form');
            const mainContainer = document.querySelector('.container');
            const reportOutput = document.getElementById('report-output');
            
            const showLoader = (show) => loader.classList.toggle('hidden', !show);
            const showMessage = (msg, isError = false) => {
                messageBox.textContent = msg;
                messageBox.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 3000);
            };

            const plantDatabase = [
                { common: "Alder", latin: "Alnus glutinosa" }, { common: "Ash", latin: "Fraxinus excelsior" }, { common: "Aspen", latin: "Populus tremula" },
                { common: "Beech", latin: "Fagus sylvatica" }, { common: "Silver Birch", latin: "Betula pendula" }, { common: "Downy Birch", latin: "Betula pubescens" },
                { common: "Blackthorn", latin: "Prunus spinosa" }, { common: "Box", latin: "Buxus sempervirens" }, { common: "Bird Cherry", latin: "Prunus padus" },
                { common: "Wild Cherry", latin: "Prunus avium" }, { common: "Crab Apple", latin: "Malus sylvestris" }, { common: "Dogwood", latin: "Cornus sanguinea" },
                { common: "Elder", latin: "Sambucus nigra" }, { common: "Hawthorn", latin: "Crataegus monogyna" }, { common: "Hazel", latin: "Corylus avellana" },
                { common: "Holly", latin: "Ilex aquifolium" }, { common: "Hornbeam", latin: "Carpinus betulus" }, { common: "Field Maple", latin: "Acer campestre" },
                { common: "Pedunculate Oak", latin: "Quercus robur" }, { common: "Sessile Oak", latin: "Quercus petraea" }, { common: "Rowan", latin: "Sorbus aucuparia" },
                { common: "Goat Willow", latin: "Salix caprea" }, { common: "White Willow", latin: "Salix alba" }, { common: "Yew", latin: "Taxus baccata" },
                { common: "Bluebell", latin: "Hyacinthoides non-scripta" }, { common: "Bugle", latin: "Ajuga reptans" }, { common: "Columbine", latin: "Aquilegia vulgaris" },
                { common: "Cowslip", latin: "Primula veris" }, { common: "Daisy", latin: "Bellis perennis" }, { common: "Dandelion", latin: "Taraxacum officinale" },
                { common: "Foxglove", latin: "Digitalis purpurea" }, { common: "Ground Ivy", latin: "Glechoma hederacea" }, { common: "Harebell", latin: "Campanula rotundifolia" },
                { common: "Herb Robert", latin: "Geranium robertianum" }, { common: "Kidney Vetch", latin: "Anthyllis vulneraria" }, { common: "Lady's Mantle", latin: "Alchemilla mollis" },
                { common: "Lesser Celandine", latin: "Ranunculus ficaria" }, { common: "Marsh Marigold", latin: "Caltha palustris" }, { common: "Meadowsweet", latin: "Filipendula ulmaria" },
                { common: "Oxeye Daisy", latin: "Leucanthemum vulgare" }, { common: "Primrose", latin: "Primula vulgaris" }, { common: "Ragged Robin", latin: "Lychnis flos-cuculi" },
                { common: "Red Campion", latin: "Silene dioica" }, { common: "Sea Thrift", latin: "Armeria maritima" }, { common: "Selfheal", latin: "Prunella vulgaris" },
                { common: "Stinging Nettle", latin: "Urtica dioica" }, { common: "Sweet Violet", latin: "Viola odorata" }, { common: "Teasel", latin: "Dipsacus fullonum" },
                { common: "Tufted Vetch", latin: "Vicia cracca" }, { common: "White Clover", latin: "Trifolium repens" }, { common: "Wood Anemone", latin: "Anemone nemorosa" },
                { common: "Wood Sorrel", latin: "Oxalis acetosella" }, { common: "Yarrow", latin: "Achillea millefolium" }, { common: "Yellow Archangel", latin: "Lamiastrum galeobdolon" },
                { common: "Yellow Iris", latin: "Iris pseudacorus" }, { common: "Common Bent", latin: "Agrostis capillaris" }, { common: "Crested Dog's-tail", latin: "Cynosurus cristatus" },
                { common: "Cock's-foot", latin: "Dactylis glomerata" }, { common: "Pendulous Sedge", latin: "Carex pendula" }, { common: "Soft Rush", latin: "Juncus effusus" },
                { common: "Yorkshire Fog", latin: "Holcus lanatus" }, { common: "Male Fern", latin: "Dryopteris filix-mas" }, { common: "Hart's-tongue Fern", latin: "Asplenium scolopendrium" },
                { common: "Bracken", latin: "Pteridium aquilinum" }
            ];
            const plantDatalist = document.getElementById('plant-datalist');
            plantDatabase.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant.common;
                plantDatalist.appendChild(option);
            });
            const bngHabitats = {
                "Cropland": ["Arable field margins cultivated annually", "Arable field margins game bird mix", "Arable field margins pollen & nectar", "Arable field margins tussocky", "Cereal crops", "Winter stubble", "Horticulture", "Intensive orchards", "Non-cereal crops", "Temporary grass and clover leys"],
                "Grassland": ["Traditional orchards", "Bracken", "Floodplain Wetland Mosaic", "Lowland calcareous grassland", "Lowland dry acid grassland", "Lowland meadows", "Modified grassland", "Other lowland acid grassland", "Other neutral grassland", "Tall herb communities", "Upland acid grassland", "Upland calcareous grassland", "Upland hay meadows"],
                "Heathland and shrub": ["Blackthorn scrub", "Bramble scrub", "Gorse scrub", "Hawthorn scrub", "Hazel scrub", "Lowland Heathland", "Mixed scrub", "Mountain heaths and willow scrub", "Rhododendron scrub", "Dunes with Sea buckthorn", "Other Sea buckthorn scrub", "Upland Heathland", "Willow Scrub"],
                "Lakes": ["Aquifer fed naturally fluctuating water bodies", "Ornamental lake or pond", "High alkalinity lakes", "Low alkalinity lakes", "Marl Lakes", "Moderate alkalinity lakes", "Peat Lakes", "Ponds (Priority Habitat)", "Ponds (Non- Priority Habitat)", "Reservoirs", "Temporary lakes, ponds and pools"],
                "Sparsely vegetated land": ["Calaminarian grasslands", "Coastal sand dunes", "Coastal vegetated shingle", "Ruderal/Ephemeral", "Inland rock outcrop and scree habitats", "Limestone pavement", "Maritime cliff and slopes", "Other inland rock and scree", "Tall Forbs"],
                "Urban": ["Allotments", "Artificial unvegetated, unsealed surface", "Bioswale", "Built linear features", "Cemeteries and churchyards", "Developed land; sealed surface", "Facade-bound green wall", "Ground based green wall", "Ground level planters", "Intensive green roof", "Introduced shrub", "Open Mosaic Habitats on Previously Developed Land", "Rain garden", "Actively worked sand pit quarry or open cast mine", "Sustainable drainage system", "Un-vegetated garden", "Vacant/derelict land", "Bareground", "Vegetated garden", "Biodiverse green roof", "Other green roof"],
                "Wetland": ["Blanket bog", "Depressions on Peat substrates", "Fens (upland and lowland)", "Lowland raised bog", "Oceanic Valley Mire", "Purple moor grass and rush pastures", "Reedbeds", "Transition mires and quaking bogs"],
                "Woodland and forest": ["Felled", "Lowland beech and yew woodland", "Lowland mixed deciduous woodland", "Native pine woodlands", "Other coniferous woodland", "Other Scot's Pine woodland", "Other woodland; broadleaved", "Other woodland; mixed", "Upland birchwoods", "Upland mixed ashwoods", "Upland oakwood", "Wet woodland", "Wood-pasture and parkland"],
                "Individual Trees": ["Rural Trees", "Urban Trees"],
                "Coastal habitats": ["Coastal lagoons", "High energy littoral rock", "Moderate energy littoral rock", "Low energy littoral rock", "Features of littoral rock", "Watercourse footprint", "Coastal saltmarsh", "Artificial saltmarshes", "Littoral coarse sediment", "Littoral mud", "Littoral mixed sediments", "Littoral seagrass", "Littoral biogenic reefs"]
            };

            const updateStepper = () => {
                document.querySelectorAll('#stepper .step').forEach((stepEl) => {
                    const stepNum = parseInt(stepEl.dataset.step);
                    stepEl.classList.toggle('step-active', stepNum === currentStep);
                    stepEl.classList.toggle('border-blue-500', stepNum === currentStep);
                    stepEl.classList.toggle('border-b-4', stepNum === currentStep);
                    stepEl.classList.toggle('text-gray-400', stepNum !== currentStep);
                    const icon = stepEl.querySelector('span:first-child');
                    icon.classList.toggle('bg-blue-500', stepNum <= currentStep);
                    icon.classList.toggle('text-white', stepNum <= currentStep);
                    icon.classList.toggle('bg-gray-300', stepNum > currentStep);
                    icon.classList.toggle('text-gray-600', stepNum > currentStep);
                });
            };

            const showStep = (step) => {
                currentStep = step;
                document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`step-${step}`).classList.remove('hidden');
                document.getElementById('prev-btn').classList.toggle('hidden', step === 1);
                document.getElementById('next-btn').classList.toggle('hidden', step === 6);
                document.getElementById('generate-report-btn').classList.toggle('hidden', step !== 6);
                if (step === 6) populateSummary();
                updateStepper();
            };

            const createSurveyorHTML = (name = '', canRemove = false) => {
                const count = document.querySelectorAll('.surveyor-item').length + 1;
                return `<div class="flex items-center space-x-2 surveyor-item"><input type="text" value="${name}" class="surveyor-name w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Surveyor ${count} Name">${canRemove ? '<button type="button" class="remove-btn text-red-500 hover:text-red-700">✕</button>' : ''}</div>`;
            };
            const createHabitatHTML = (data = {}) => {
                const count = document.querySelectorAll('.habitat-entry').length + 1;
                const parcelsHTML = (data.parcels || []).map(p => createParcelHTML(p)).join('');
                let optionsHTML = '<option value="">Select habitat...</option>';
                for (const group in bngHabitats) {
                    optionsHTML += `<optgroup label="${group}">`;
                    bngHabitats[group].forEach(hab => {
                         optionsHTML += `<option value="${hab}" ${data.type === hab ? 'selected' : ''}>${hab}</option>`;
                    });
                    optionsHTML += `</optgroup>`;
                }
                return `<div class="habitat-entry bg-gray-50 p-4 rounded-lg border"><h3 class="font-semibold text-lg mb-2">Habitat ${count}</h3><div><label class="block text-sm font-medium text-gray-700 mb-1">Habitat Type</label><select class="habitat-type w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">${optionsHTML}</select></div><div class="parcels-container mt-4 space-y-4 border-t pt-4">${parcelsHTML}</div><button type="button" class="add-parcel-btn mt-4 inline-flex items-center px-3 py-1.5 border border-dashed text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200">Add Parcel</button></div>`;
            };
            const createParcelHTML = (data = {}) => {
                const plantsHTML = (data.plants || []).map(p => createPlantHTML(p)).join('');
                return `<div class="parcel-entry bg-white p-4 rounded-lg border border-gray-200"><div class="flex justify-between items-center"><h4 class="font-semibold text-md">Parcel</h4><button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-xs">Remove</button></div><div><label class="block text-sm font-medium text-gray-700 mt-2 mb-1">Parcel Number / Ref</label><input type="text" class="parcel-ref w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm" placeholder="e.g., P123" value="${data.ref || ''}"></div><div class="mt-2 relative"><label class="block text-sm font-medium text-gray-700 mb-1">Description</label><textarea class="parcel-description w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm" rows="3">${data.description || ''}</textarea><button type="button" class="generate-desc-btn absolute bottom-2 right-2 text-xs text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:bg-gradient-to-l rounded-full px-2 py-1">✨ AI</button></div><div class="mt-4 border-t pt-3"><label class="block text-sm font-medium text-gray-700 mb-1">Search and Add Plant</label><input type="text" list="plant-datalist" class="plant-search w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm" placeholder="Start typing..."><div class="plant-list-container mt-2 space-y-2">${plantsHTML}</div></div></div>`;
            };
            const createPlantHTML = (plant) => `<div class="plant-list-item bg-gray-100 p-2 rounded-md flex justify-between items-center" data-common-name="${plant.common}" data-latin-name="${plant.latin}"><p class="text-sm"><strong>${plant.common}</strong> <em>(${plant.latin})</em></p><button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-xs">✕</button></div>`;
            const createBuildingHTML = (data = {}) => {
                const count = document.querySelectorAll('.building-entry').length + 1;
                const suitabilityOptions = ['None', 'Negligible', 'Low', 'Moderate', 'High'];
                const proposalOptions = ['Retain', 'Convert', 'Demolish'];
                const surveyOptions = ['Yes', 'No'];

                return `
                <div class="building-entry bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-center">
                         <h3 class="font-semibold text-lg mb-2">Building ${count}</h3>
                         <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-xs">Remove</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium">Building Number</label><input type="text" class="building-number w-full mt-1 p-2 border rounded-lg" value="${data.number || ''}"></div>
                        <div><label class="block text-sm font-medium">Proposal</label><select class="building-proposal w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select proposal...</option>${proposalOptions.map(o => `<option value="${o}" ${data.proposal === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">General Description</label><textarea class="building-description w-full mt-1 p-2 border rounded-lg" rows="3">${data.description || ''}</textarea></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Bat Roost Features</label><textarea class="building-features w-full mt-1 p-2 border rounded-lg" rows="3">${data.features || ''}</textarea></div>
                        <div><label class="block text-sm font-medium">Bat Roost Suitability</label><select class="building-suitability w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select suitability...</option>${suitabilityOptions.map(o => `<option value="${o}" ${data.suitability === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium">Surveys Required?</label><select class="building-surveys-required w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select option...</option>${surveyOptions.map(o => `<option value="${o}" ${data.surveysRequired === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium">No. IR Cameras</label><input type="number" class="building-ir-cameras w-full mt-1 p-2 border rounded-lg" value="${data.irCameras || ''}"></div>
                        <div><label class="block text-sm font-medium">No. Floaters</label><input type="number" class="building-floaters w-full mt-1 p-2 border rounded-lg" value="${data.floaters || ''}"></div>
                        <div><label class="block text-sm font-medium">No. Human Surveyors</label><input type="number" class="building-human-surveyors w-full mt-1 p-2 border rounded-lg" value="${data.humanSurveyors || ''}"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Justification for Human Surveyors</label><textarea class="building-justification w-full mt-1 p-2 border rounded-lg" rows="2">${data.justification || ''}</textarea></div>
                        <div><label class="block text-sm font-medium">Photo</label><input type="file" accept="image/*" class="building-photo w-full text-sm"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Potential Survey Limitations</label><textarea class="building-limitations w-full mt-1 p-2 border rounded-lg" rows="2">${data.limitations || ''}</textarea></div>
                    </div>
                </div>`;
            };
            const createTreeHTML = (data = {}) => {
                const count = document.querySelectorAll('.tree-entry').length + 1;
                const suitabilityOptions = ['None', 'FAR', 'PRF-I', 'PRF-M'];
                const proposalOptions = ['Retain', 'Cut back / Prune', 'Remove'];
                const surveyOptions = ['No', 'Yes - Endoscope from ladder', 'Yes - Endoscope climbing', 'Yes - IR camera survey'];
                const treeSpeciesOptions = plantDatabase.filter(p => ["Alder", "Ash", "Aspen", "Beech", "Silver Birch", "Downy Birch", "Blackthorn", "Box", "Bird Cherry", "Wild Cherry", "Crab Apple", "Dogwood", "Elder", "Hawthorn", "Hazel", "Holly", "Hornbeam", "Field Maple", "Pedunculate Oak", "Sessile Oak", "Rowan", "Goat Willow", "White Willow", "Yew"].includes(p.common));
                const featureOptions = ['Woodpecker hole', 'Rot hole / Cavity', 'Crack / Split (e.g., frost crack, helical split)', 'Hazard beam', 'Tear-out / Limb-snap', 'Loose / Flaking bark', 'Dense ivy cover', 'Other'];

                return `
                <div class="tree-entry bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-center">
                         <h3 class="font-semibold text-lg mb-2">Tree ${count}</h3>
                         <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-xs">Remove</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium">Tree Number/Ref</label><input type="text" class="tree-number w-full mt-1 p-2 border rounded-lg" value="${data.number || ''}"></div>
                        <div><label class="block text-sm font-medium">Species</label><select class="tree-species w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select species...</option>${treeSpeciesOptions.map(o => `<option value="${o.common}" ${data.species === o.common ? 'selected' : ''}>${o.common}</option>`).join('')}</select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Description/Condition</label><textarea class="tree-description w-full mt-1 p-2 border rounded-lg" rows="3">${data.description || ''}</textarea></div>
                        <div class="md:col-span-2">
                           <label class="block text-sm font-medium">Bat Roost Features</label>
                           <select class="tree-features-select w-full mt-1 p-2 border rounded-lg bg-white">
                                <option value="">Select a feature...</option>
                                ${featureOptions.map(o => `<option value="${o}" ${data.features === o ? 'selected' : ''}>${o}</option>`).join('')}
                           </select>
                           <textarea class="tree-features-other hidden w-full mt-2 p-2 border rounded-lg" rows="2" placeholder="Describe other features...">${data.features && !featureOptions.includes(data.features) ? data.features : ''}</textarea>
                        </div>
                        <div><label class="block text-sm font-medium">Bat Roost Suitability</label><select class="tree-suitability w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select suitability...</option>${suitabilityOptions.map(o => `<option value="${o}" ${data.suitability === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium">Surveys Required?</label><select class="tree-surveys-required w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select option...</option>${surveyOptions.map(o => `<option value="${o}" ${data.surveysRequired === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                         <div><label class="block text-sm font-medium">Proposal</label><select class="tree-proposal w-full mt-1 p-2 border rounded-lg bg-white"><option value="">Select proposal...</option>${proposalOptions.map(o => `<option value="${o}" ${data.proposal === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>
                         <div><label class="block text-sm font-medium">No. IR Cameras</label><input type="number" class="tree-ir-cameras w-full mt-1 p-2 border rounded-lg" value="${data.irCameras || ''}"></div>
                        <div><label class="block text-sm font-medium">Photo</label><input type="file" accept="image/*" class="tree-photo w-full text-sm"></div>
                    </div>
                </div>`;
            };

            peaForm.addEventListener('click', e => {
                if (e.target.matches('.remove-btn')) {
                    e.target.closest('.surveyor-item, .parcel-entry, .plant-list-item, .building-entry, .tree-entry')?.remove();
                }
                if (e.target.matches('.add-parcel-btn')) {
                    e.target.previousElementSibling.insertAdjacentHTML('beforeend', createParcelHTML());
                }
                if (e.target.matches('.generate-desc-btn')) {
                    generateHabitatDescription(e.target);
                }
                if (e.target.matches('.accordion-header')) {
                    const content = e.target.nextElementSibling;
                    content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
                }
            });

            peaForm.addEventListener('input', e => {
                if (e.target.matches('.plant-search')) {
                    const plant = plantDatabase.find(p => p.common.toLowerCase() === e.target.value.toLowerCase());
                    if (plant) {
                        const container = e.target.nextElementSibling;
                        if (!Array.from(container.children).some(el => el.dataset.commonName === plant.common)) {
                            container.insertAdjacentHTML('beforeend', createPlantHTML(plant));
                        }
                        e.target.value = '';
                    }
                }
                if(e.target.matches('.tree-features-select')){
                    const otherTextarea = e.target.nextElementSibling;
                    otherTextarea.classList.toggle('hidden', e.target.value !== 'Other');
                }
            });

            const getProjectDataFromForm = () => { /* see implementation below */ };
            const populateFormWithData = (data) => { /* see implementation below */ };
            const generateReport = () => { /* see implementation below */ };
            const populateSummary = () => { /* see implementation below */ };
            
            window.getProjectDataFromForm = () => {
                const form = document.getElementById('pea-form');
                const protectedSpeciesData = {};
                form.querySelectorAll('[data-species-field]').forEach(field => {
                    const key = field.dataset.speciesField;
                    protectedSpeciesData[key] = field.type === 'checkbox' ? field.checked : field.value;
                });

                return {
                    projectName: form.projectName.value, projectNumber: form.projectNumber.value, siteAddress: form.siteAddress.value,
                    surveyors: Array.from(form.querySelectorAll('.surveyor-name')).map(i=>i.value).filter(Boolean),
                    gridReference: form.gridReference.value, date: form.date.value, startTime: form.startTime.value, endTime: form.endTime.value,
                    temperature: form.temperature.value, cloudCover: form.cloudCover.value, wind: form.wind.value, rain: form.rain.value,
                    groundConditions: form.groundConditions.value, surveyLimitations: form.surveyLimitations.value,
                    habitats: Array.from(form.querySelectorAll('.habitat-entry')).map(h => ({
                        type: h.querySelector('.habitat-type').value,
                        parcels: Array.from(h.querySelectorAll('.parcel-entry')).map(p => ({
                            ref: p.querySelector('.parcel-ref').value,
                            description: p.querySelector('.parcel-description').value,
                            plants: Array.from(p.querySelectorAll('.plant-list-item')).map(pl => ({ common: pl.dataset.commonName, latin: pl.dataset.latinName }))
                        }))
                    })),
                    buildings: Array.from(form.querySelectorAll('.building-entry')).map(b => ({
                        number: b.querySelector('.building-number').value,
                        proposal: b.querySelector('.building-proposal').value,
                        description: b.querySelector('.building-description').value,
                        features: b.querySelector('.building-features').value,
                        suitability: b.querySelector('.building-suitability').value,
                        surveysRequired: b.querySelector('.building-surveys-required').value,
                        irCameras: b.querySelector('.building-ir-cameras').value,
                        floaters: b.querySelector('.building-floaters').value,
                        humanSurveyors: b.querySelector('.building-human-surveyors').value,
                        justification: b.querySelector('.building-justification').value,
                        limitations: b.querySelector('.building-limitations').value
                    })),
                    trees: Array.from(form.querySelectorAll('.tree-entry')).map(t => {
                        const featuresSelect = t.querySelector('.tree-features-select');
                        const features = featuresSelect.value === 'Other' ? t.querySelector('.tree-features-other').value : featuresSelect.value;
                        return {
                            number: t.querySelector('.tree-number').value,
                            species: t.querySelector('.tree-species').value,
                            description: t.querySelector('.tree-description').value,
                            features: features,
                            suitability: t.querySelector('.tree-suitability').value,
                            surveysRequired: t.querySelector('.tree-surveys-required').value,
                            proposal: t.querySelector('.tree-proposal').value,
                            irCameras: t.querySelector('.tree-ir-cameras').value
                        };
                    }),
                    protectedSpecies: protectedSpeciesData
                };
            };
            
            window.populateFormWithData = (data) => {
                const form = document.getElementById('pea-form');
                form.reset();
                const containers = {
                    surveyors: document.getElementById('surveyors-container'),
                    habitats: document.getElementById('habitats-container'),
                    buildings: document.getElementById('buildings-container'),
                    trees: document.getElementById('trees-container')
                };
                Object.values(containers).forEach(c => c.innerHTML = '');

                form.projectName.value = data.projectName || '';
                form.projectNumber.value = data.projectNumber || '';
                form.siteAddress.value = data.siteAddress || '';
                if (data.surveyors?.length) data.surveyors.forEach((name, i) => containers.surveyors.insertAdjacentHTML('beforeend', createSurveyorHTML(name, i > 0)));
                else containers.surveyors.innerHTML = createSurveyorHTML();
                document.getElementById('add-surveyor-btn').classList.toggle('hidden', (data.surveyors?.length || 0) >= 4);

                Object.keys(data).forEach(key => {
                    if(form[key] && typeof form[key] !== 'function' && typeof form[key].value !== 'undefined') {
                       form[key].value = data[key] || '';
                    }
                });

                if(data.habitats?.length) data.habitats.forEach(h => containers.habitats.insertAdjacentHTML('beforeend', createHabitatHTML(h)));
                else containers.habitats.innerHTML = createHabitatHTML();
                
                if(data.buildings?.length) data.buildings.forEach(b => containers.buildings.insertAdjacentHTML('beforeend', createBuildingHTML(b)));
                else containers.buildings.innerHTML = createBuildingHTML();

                if(data.trees?.length) data.trees.forEach(t => containers.trees.insertAdjacentHTML('beforeend', createTreeHTML(t)));
                else containers.trees.innerHTML = createTreeHTML();

                // Handle "Other" for tree features on load
                document.querySelectorAll('.tree-entry').forEach((treeEntry, index) => {
                    const featureData = data.trees[index]?.features || '';
                    const select = treeEntry.querySelector('.tree-features-select');
                    const otherText = treeEntry.querySelector('.tree-features-other');
                    const standardOptions = Array.from(select.options).map(opt => opt.value);
                    if(featureData && !standardOptions.includes(featureData)){
                        select.value = 'Other';
                        otherText.value = featureData;
                        otherText.classList.remove('hidden');
                    } else {
                        select.value = featureData;
                    }
                });

                if(data.protectedSpecies){
                    Object.keys(data.protectedSpecies).forEach(key => {
                        const field = form.querySelector(`[data-species-field="${key}"]`);
                        if(field){
                            if(field.type === 'checkbox') field.checked = data.protectedSpecies[key];
                            else field.value = data.protectedSpecies[key] || '';
                        }
                    });
                }
            };

            window.populateSummary = () => {
                const data = getProjectDataFromForm();
                let summaryHTML = `<p><strong>Project:</strong> ${data.projectName||'-'} (${data.projectNumber||'-'})</p><p><strong>Site:</strong> ${data.siteAddress||'-'}</p><p><strong>Date:</strong> ${data.date||'-'}</p><hr class="my-4">`;
                data.habitats.forEach(h => {
                    if (h.type) {
                        summaryHTML += `<div><h4 class="font-semibold text-lg">${h.type}</h4>`;
                        if (h.parcels.length > 0) summaryHTML += `<ul class="list-disc list-inside ml-4">${h.parcels.map(p => `<li>${p.ref||'Unnamed Parcel'} (${p.plants.length} plants)</li>`).join('')}</ul>`;
                        summaryHTML += `</div>`;
                    }
                });
                if (data.buildings.some(b => b.number)) {
                    summaryHTML += `<hr class="my-4"><h4 class="font-semibold text-lg">Buildings:</h4><ul>${data.buildings.filter(b => b.number).map(b => `<li>Building ${b.number} (${b.suitability} suitability)</li>`).join('')}</ul>`;
                }
                if (data.trees.some(t => t.number)) {
                    summaryHTML += `<hr class="my-4"><h4 class="font-semibold text-lg">Trees:</h4><ul>${data.trees.filter(t => t.number).map(t => `<li>Tree ${t.number} (${t.species})</li>`).join('')}</ul>`;
                }
                document.getElementById('summary-content').innerHTML = summaryHTML;
            };

            window.generateReport = () => {
                const reportData = getProjectDataFromForm();
                const reportContent = document.getElementById('report-content');
                const valOrDash = (val) => val || '-';
                let reportHTML = `<div class="text-center mb-8"><h2 class="text-3xl font-bold">${valOrDash(reportData.projectName)}</h2><p class="text-lg">${valOrDash(reportData.siteAddress)}</p><p><strong>Project No:</strong> ${valOrDash(reportData.projectNumber)} | <strong>Grid Ref:</strong> ${valOrDash(reportData.gridReference)}</p></div><div class="mb-6 p-4 bg-gray-50 rounded-lg"><h3 class="text-xl font-bold mb-4 border-b pb-2">Survey Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 text-sm"><div><p><strong>Date:</strong> ${valOrDash(reportData.date)}</p><p><strong>Ecologist(s):</strong> ${reportData.surveyors.join(', ')||'-'}</p><p><strong>Start Time:</strong> ${valOrDash(reportData.startTime)}</p><p><strong>End Time:</strong> ${valOrDash(reportData.endTime)}</p></div><div><p><strong>Temperature:</strong> ${reportData.temperature?reportData.temperature+'°C':'-'}</p><p><strong>Cloud cover:</strong> ${valOrDash(reportData.cloudCover)}</p><p><strong>Wind:</strong> ${valOrDash(reportData.wind)}</p><p><strong>Rain:</strong> ${valOrDash(reportData.rain)}</p></div><div class="md:col-span-2 mt-2"><p><strong>Ground Conditions:</strong> ${valOrDash(reportData.groundConditions)}</p></div><div class="md:col-span-2 mt-2"><p><strong>Survey Limitations:</strong> ${valOrDash(reportData.surveyLimitations)}</p></div></div></div>`;
                reportHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">1. Habitats and Plant Species</h3>`;
                reportData.habitats.forEach(h => {
                    if (h.type) {
                        reportHTML += `<div class="mb-6 break-inside-avoid"><h4 class="text-xl font-bold">${h.type}</h4>`;
                        h.parcels.forEach(p => {
                            reportHTML += `<div class="ml-4 mt-2 p-3 bg-gray-50 rounded-lg"><h5 class="font-semibold">Parcel: ${valOrDash(p.ref)}</h5><p class="text-sm">${valOrDash(p.description)}</p>`;
                            if (p.plants.length > 0) reportHTML += `<h6 class="font-semibold mt-2">Plant Species Recorded:</h6><ul class="list-disc list-inside text-sm">${p.plants.map(pl=>`<li><strong>${pl.common}</strong> <em>(${pl.latin})</em></li>`).join('')}</ul>`;
                            reportHTML += `</div>`;
                        });
                        reportHTML += `</div>`;
                    }
                });
                
                let sectionCounter = 2;
                if(reportData.buildings.some(b => b.number)) {
                    reportHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">${sectionCounter}. Buildings</h3>`;
                    sectionCounter++;
                    const buildingPhotoInputs = document.querySelectorAll('.building-entry .building-photo');
                    reportData.buildings.forEach((b, i) => {
                        if (b.number) {
                            reportHTML += `<div class="mb-4 break-inside-avoid"><h4 class="text-xl font-bold">Building ${b.number}</h4><p><strong>Proposal:</strong> ${valOrDash(b.proposal)}</p><p><strong>Description:</strong> ${valOrDash(b.description)}</p><p><strong>Bat Roost Features:</strong> ${valOrDash(b.features)}</p><p><strong>Bat Roost Suitability:</strong> ${valOrDash(b.suitability)}</p><p><strong>Further Surveys Required:</strong> ${valOrDash(b.surveysRequired)}</p><p><strong>Survey Effort:</strong> ${b.irCameras||'0'} IR cameras, ${b.floaters||'0'} floaters, ${b.humanSurveyors||'0'} surveyors</p><p><strong>Surveyor Justification:</strong> ${valOrDash(b.justification)}</p><p><strong>Potential Survey Limitations:</strong> ${valOrDash(b.limitations)}</p>`;
                            if (buildingPhotoInputs[i]?.files[0]) reportHTML += `<img src="${URL.createObjectURL(buildingPhotoInputs[i].files[0])}" class="mt-2 rounded-lg max-w-sm mx-auto">`;
                            reportHTML += `</div>`;
                        }
                    });
                }
                
                if(reportData.trees.some(t => t.number)) {
                    reportHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">${sectionCounter}. Trees</h3>`;
                    sectionCounter++;
                    const treePhotoInputs = document.querySelectorAll('.tree-entry .tree-photo');
                    reportData.trees.forEach((t, i) => {
                        if (t.number) {
                            reportHTML += `<div class="mb-4 break-inside-avoid"><h4 class="text-xl font-bold">Tree ${t.number} (${valOrDash(t.species)})</h4><p><strong>Proposal:</strong> ${valOrDash(t.proposal)}</p><p><strong>Description/Condition:</strong> ${valOrDash(t.description)}</p><p><strong>Bat Roost Features:</strong> ${valOrDash(t.features)}</p><p><strong>Bat Roost Suitability:</strong> ${valOrDash(t.suitability)}</p><p><strong>Further Surveys Required:</strong> ${valOrDash(t.surveysRequired)}</p><p><strong>IR Cameras:</strong> ${t.irCameras||'0'}</p>`;
                            if (treePhotoInputs[i]?.files[0]) reportHTML += `<img src="${URL.createObjectURL(treePhotoInputs[i].files[0])}" class="mt-2 rounded-lg max-w-sm mx-auto">`;
                            reportHTML += `</div>`;
                        }
                    });
                }
                
                reportHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">${sectionCounter}. Protected Species Potential</h3>`;
                sectionCounter++;
                const ps = reportData.protectedSpecies;
                reportHTML += `<div class="prose prose-sm max-w-none">
                    <h4>Foraging & Commuting Bats</h4>
                    <p><strong>Habitat Suitability:</strong> ${valOrDash(ps.bats_habitat_desc)}</p>
                    <p><strong>Further Surveys Required:</strong> ${valOrDash(ps.bats_survey_req)}</p>
                    <p><strong>Suitability for Survey:</strong> ${valOrDash(ps.bats_survey_suitability)}</p>
                    <p><strong>Transects:</strong> ${valOrDash(ps.bats_transects)} | <strong>Vantage Points:</strong> ${valOrDash(ps.bats_vps)}</p>
                    
                    <h4>Hazel Dormice</h4>
                    <p><strong>Habitat Suitability:</strong> ${valOrDash(ps.dormice_habitat)}</p>
                    <p><strong>Evidence:</strong> ${valOrDash(ps.dormice_evidence)}</p>

                    <h4>Badger</h4>
                    <p><strong>Field Signs:</strong> ${valOrDash(ps.badger_signs)}</p>
                    <p><strong>Sett on site:</strong> ${ps.badger_sett_onsite ? 'Yes' : 'No'}</p>
                    <p><strong>30m Buffer Checked:</strong> ${ps.badger_buffer_checked ? 'Yes' : 'No'}</p>

                    <h4>Reptiles</h4>
                    <p><strong>Habitat Suitability:</strong> ${valOrDash(ps.reptiles_habitat)}</p>
                    
                    <h4>Great Crested Newts</h4>
                    <p><strong>HSI Score:</strong> ${valOrDash(ps.gcn_hsi)}</p>
                    <p><strong>Terrestrial Habitat Quality:</strong> ${valOrDash(ps.gcn_habitat)}</p>
                    <p><strong>Ponds on/within 500m:</strong> ${valOrDash(ps.gcn_ponds)}</p>
                    
                    <h4>Birds</h4>
                    <p><strong>Nesting Opportunities:</strong> ${valOrDash(ps.birds_nesting)}</p>
                    <p><strong>Notable Species Observed:</strong> ${valOrDash(ps.birds_observed)}</p>

                    <h4>Riparian Mammals</h4>
                    <p><strong>Waterbody Suitability:</strong> ${valOrDash(ps.riparian_suitability)}</p>
                    <p><strong>Field Signs:</strong> ${valOrDash(ps.riparian_signs)}</p>
                    
                    <h4>Other Protected Species</h4>
                    <p>${valOrDash(ps.other_species_notes)}</p>
                </div>`;

                const mitigationContent = document.getElementById('mitigation-content').innerHTML;
                if (mitigationContent) reportHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">${sectionCounter++}. Potential Impacts & Mitigation</h3><div class="prose prose-sm max-w-none">${mitigationContent}</div>`;
                const sitePlanInput = document.getElementById('site-plan-upload');
                if (sitePlanInput.files[0]) reportHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">${sectionCounter}. Site Plan</h3><img src="${URL.createObjectURL(sitePlanInput.files[0])}" class="mt-2 rounded-lg max-w-full mx-auto">`;
                reportContent.innerHTML = reportHTML;
                mainContainer.classList.add('hidden');
                reportOutput.classList.remove('hidden');
            };
            
            async function callGemini(prompt) { /* ... implementation ... */ }
            async function generateHabitatDescription(button) { /* ... implementation ... */ }
            
            document.getElementById('next-btn').addEventListener('click', () => showStep(currentStep + 1));
            document.getElementById('prev-btn').addEventListener('click', () => showStep(currentStep - 1));
            document.getElementById('add-surveyor-btn').addEventListener('click', () => {
                const container = document.getElementById('surveyors-container');
                if (container.children.length < 4) {
                    container.insertAdjacentHTML('beforeend', createSurveyorHTML('', true));
                }
                document.getElementById('add-surveyor-btn').classList.toggle('hidden', container.children.length >= 4);
            });
            document.getElementById('add-habitat-btn').addEventListener('click', () => document.getElementById('habitats-container').insertAdjacentHTML('beforeend', createHabitatHTML()));
            document.getElementById('add-building-btn').addEventListener('click', () => document.getElementById('buildings-container').insertAdjacentHTML('beforeend', createBuildingHTML()));
            document.getElementById('add-tree-btn').addEventListener('click', () => document.getElementById('trees-container').insertAdjacentHTML('beforeend', createTreeHTML()));
            
            document.getElementById('save-btn').addEventListener('click', async () => { /* save logic */ });
            document.getElementById('load-btn').addEventListener('click', async () => { /* load logic */ });
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('generate-mitigation-btn').addEventListener('click', async () => { /* mitigation logic */ });
            document.getElementById('back-to-form-btn').addEventListener('click', () => {
                 mainContainer.classList.remove('hidden');
                 reportOutput.classList.remove('hidden');
            });
            document.getElementById('print-report-btn').addEventListener('click', () => window.print());

            // --- Full Function Implementations ---
            window.callGemini = async (prompt) => {
                showLoader(true);
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        return result.candidates[0].content.parts[0].text;
                    }
                    throw new Error("Invalid response structure from API.");
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    showMessage("AI generation failed. Please check console.", true);
                    return '';
                } finally {
                    showLoader(false);
                }
            }
             window.generateHabitatDescription = async (button) => {
                const parcelEntry = button.closest('.parcel-entry');
                const habitatType = parcelEntry.closest('.habitat-entry').querySelector('.habitat-type').value;
                const plantList = Array.from(parcelEntry.querySelectorAll('.plant-list-item')).map(p => p.dataset.commonName);
                if (!habitatType) { showMessage("Please enter a Habitat Type first.", true); return; }
                const prompt = `As an expert ecologist, write a professional, descriptive paragraph for a Preliminary Ecological Appraisal report. The habitat is "${habitatType}". The notable plant species recorded in this specific parcel are: ${plantList.join(', ')}. Describe the typical characteristics of this habitat and incorporate the presence of the listed species.`;
                const description = await callGemini(prompt);
                if(description) parcelEntry.querySelector('.parcel-description').value = description;
            };

            document.getElementById('save-btn').onclick = async () => {
                const projectNumber = document.getElementById('projectNumber').value;
                if (!projectNumber) return showMessage("Project Number is required to save.", true);
                showLoader(true);
                try {
                    if (!db) throw new Error("Database not initialized.");
                    await setDoc(doc(db, "projects", projectNumber), getProjectDataFromForm());
                    showMessage("Project saved successfully!");
                } catch (e) {
                    showMessage("Error saving project. Check console.", true); console.error(e);
                } finally { showLoader(false); }
            };
            
            document.getElementById('load-btn').onclick = async () => {
                const projectNumber = document.getElementById('loadProjectNumber').value;
                if (!projectNumber) return showMessage("Enter a Project Number to load.", true);
                showLoader(true);
                try {
                     if (!db) throw new Error("Database not initialized.");
                    const docSnap = await getDoc(doc(db, "projects", projectNumber));
                    if (docSnap.exists()) {
                        populateFormWithData(docSnap.data());
                        showMessage("Project loaded successfully!");
                    } else { showMessage("No project found with that number.", true); }
                } catch (e) {
                    showMessage("Error loading project. Check console.", true); console.error(e);
                } finally { showLoader(false); }
            };

             document.getElementById('generate-mitigation-btn').onclick = async () => {
                const data = getProjectDataFromForm();
                const habitatSummary = data.habitats.filter(h => h.type).map(h => `- ${h.type}`).join('\n');
                const buildingSummary = data.buildings.filter(b => b.number).map(b => `- Building ${b.number} with ${b.suitability} bat roost suitability.`).join('\n');
                const treeSummary = data.trees.filter(t => t.number).map(t => `- Tree ${t.number} (${t.species}) with ${t.suitability} bat roost suitability.`).join('\n');
                if (!habitatSummary && !buildingSummary && !treeSummary) return showMessage("Please record habitats, buildings, or trees first.", true);
                
                let prompt = `As an expert ecologist, review the following summary from a Preliminary Ecological Appraisal. Based on this, provide a bulleted list of potential ecological impacts and recommended mitigation or enhancement measures suitable for a standard PEA report.\n\n`;
                if(habitatSummary) prompt += `Habitats Recorded:\n${habitatSummary}\n\n`;
                if(buildingSummary) prompt += `Buildings Recorded:\n${buildingSummary}\n\n`;
                if(treeSummary) prompt += `Trees Recorded:\n${treeSummary}`;

                const suggestions = await callGemini(prompt);
                if (suggestions) {
                    document.getElementById('mitigation-output').classList.remove('hidden');
                    document.getElementById('mitigation-content').innerHTML = suggestions.replace(/\n/g, '<br>');
                }
            };
            
            // --- Initial Setup ---
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                signInAnonymously(auth).catch(err => {
                    console.error("Firebase sign-in failed:", err);
                    showMessage("Firebase sign-in failed. Check console and Firebase Auth settings.", true);
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showMessage("Could not connect to database. Check Firebase config in code.", true);
            }
            
            showStep(1);
            document.getElementById('surveyors-container').innerHTML = createSurveyorHTML();
            document.getElementById('habitats-container').innerHTML = createHabitatHTML();
            document.getElementById('buildings-container').innerHTML = createBuildingHTML();
            document.getElementById('trees-container').innerHTML = createTreeHTML();
        });
    </script>
</body>
</html>
